<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធសម្គាល់ផ្ទៃមុខ</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js for face recognition -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* Custom styles for video and canvas overlay */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 720px;
            margin: 0 auto;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        #video, #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #video {
            object-fit: cover;
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24 mb-4"></div>
        <h2 class="text-center text-xl font-semibold text-gray-700">កំពុងរៀបចំប្រព័ន្ធ...</h2>
        <p id="loading-status" class="text-center text-gray-500 mt-2">សូមរង់ចាំបន្តិច</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">ប្រព័ន្ធវិភាគ និងសម្គាល់ផ្ទៃមុខ</h1>
            <p class="text-gray-600 mt-2">ស្កេនមុខដើម្បីแสดงព័ត៌មានពី Google Sheet</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <!-- Video Feed Section -->
            <div class="bg-white p-4 rounded-lg shadow-md w-full">
                <h2 class="text-xl font-semibold mb-4 text-center">កាមេរ៉ា</h2>
                <div id="video-wrapper" class="video-container aspect-video bg-gray-900 rounded-lg">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="overlay"></canvas>
                </div>
            </div>

            <!-- Information Section -->
            <div class="bg-white p-6 rounded-lg shadow-md w-full">
                <h2 class="text-xl font-semibold mb-4 text-center">ព័ត៌មានដែលរកឃើញ</h2>
                <div id="result-container" class="space-y-3">
                    <div class="flex items-center justify-center text-gray-500 h-64" id="placeholder">
                        <p>កំពុងរង់ចាំការស្កេន...</p>
                    </div>
                    <div id="info-card" class="hidden animate-pulse">
                        <div class="bg-gray-200 rounded-lg p-4">
                            <div class="h-6 bg-gray-300 rounded w-3/4 mb-4"></div>
                            <div class="space-y-2">
                                <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                                <div class="h-4 bg-gray-300 rounded w-5/6"></div>
                                <div class="h-4 bg-gray-300 rounded w-2/3"></div>
                                <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                                <div class="h-4 bg-gray-300 rounded w-4/6"></div>
                                <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingStatus = document.getElementById('loading-status');
        const resultContainer = document.getElementById('result-container');
        const placeholder = document.getElementById('placeholder');
        const infoCard = document.getElementById('info-card');

        // --- Google Sheet Configuration ---
        const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const SHEET_NAME = 'DIList';
        const GOOGLE_SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;
        
        // --- Main execution ---
        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models'),
            faceapi.nets.faceLandmark68Net.loadFromUri('/models'),
            faceapi.nets.faceRecognitionNet.loadFromUri('/models'),
            faceapi.nets.ssdMobilenetv1.loadFromUri('/models'), // For better reference image detection
        ]).then(startSystem);

        async function startSystem() {
            try {
                updateStatus('កំពុងចាប់ផ្តើមបើកកាមេរ៉ា...');
                await startWebcam();
                updateStatus('កំពុងទាញយកទិន្នន័យបុគ្គល...');
                const labeledFaceDescriptors = await getLabeledFaceDescriptors();
                if (!labeledFaceDescriptors || labeledFaceDescriptors.length === 0) {
                    throw new Error("មិនអាចទាញយកទិន្នន័យផ្ទៃមុខយោងបានទេ");
                }
                updateStatus('ប្រព័ន្ធបានត្រៀមរួចរាល់សម្រាប់ប្រើប្រាស់');
                loadingOverlay.style.display = 'none';
                recognizeFaces(labeledFaceDescriptors);
            } catch (error) {
                console.error(error);
                loadingStatus.textContent = `មានបញ្ហា​កើតឡើង: ${error.message}។ សូមព្យាយាមផ្ទុកទំព័រឡើងវិញ។`;
                loadingStatus.classList.add('text-red-500');
            }
        }

        function startWebcam() {
            return navigator.mediaDevices.getUserMedia({ video: {} })
                .then(stream => {
                    video.srcObject = stream;
                    return new Promise(resolve => video.onloadedmetadata = resolve);
                })
                .catch(err => {
                    console.error("Error accessing webcam: ", err);
                    throw new Error("មិនអាចចូលប្រើកាមេរ៉ាបានទេ");
                });
        }
        
        function updateStatus(message) {
            loadingStatus.textContent = message;
        }

        /**
         * Fetches data from Google Sheets, processes it, and creates labeled face descriptors.
         */
        async function getLabeledFaceDescriptors() {
            updateStatus('កំពុងទាញយកទិន្នន័យពី Google Sheet...');
            const response = await fetch(GOOGLE_SHEET_URL);
            if (!response.ok) {
                throw new Error('មិនអាចភ្ជាប់ទៅកាន់ Google Sheet បានទេ');
            }
            const csvData = await response.text();
            
            // Parse CSV data
            const rows = csvData.split('\n').slice(1); // Skip header row
            const peopleData = rows.map(row => {
                // The gviz CSV output wraps strings in quotes and escapes inner quotes.
                // A simple split by comma can be fragile. This regex is more robust.
                const columns = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)
                                   .map(col => col.replace(/"/g, ''));

                if (columns.length < 27) return null; // Ensure there are enough columns

                return {
                    id: columns[4],       // Column E
                    table: columns[7],    // Column H
                    name: columns[11],    // Column L
                    gender: columns[13],  // Column N
                    class: columns[17],   // Column R
                    department: columns[18], // Column S
                    photoUrl: columns[26] // Column AA
                };
            }).filter(p => p && p.id && p.photoUrl && p.photoUrl.startsWith('http'));

            if (peopleData.length < 8) { // Data starts at row 9, so there must be at least one entry.
                 console.warn("No valid data found after row 8. Please check your sheet.");
                 return [];
            }
            const relevantData = peopleData.slice(7); // Data starts at row 9 (index 8, slice from 7)

            updateStatus(`បានរកឃើញទិន្នន័យ ${relevantData.length} នាក់ កំពុងដំណើរការរូបភាព...`);

            const descriptors = [];
            let processedCount = 0;

            for (const person of relevantData) {
                try {
                    // IMPORTANT: The image URL must be a direct link to the image file (e.g., .jpg, .png).
                    // Google Drive links like "drive.google.com/..." will NOT work directly.
                    // You must make the images publicly accessible and use their direct URL.
                    // We add a CORS proxy to help with potential cross-origin issues.
                    const imageUrl = `https://cors-anywhere.herokuapp.com/${person.photoUrl}`;
                    
                    const img = await faceapi.fetchImage(imageUrl);
                    const detections = await faceapi.detectSingleFace(img, new faceapi.SsdMobilenetv1Options())
                        .withFaceLandmarks()
                        .withFaceDescriptor();
                    
                    if (detections) {
                        const descriptor = new faceapi.LabeledFaceDescriptors(person.id, [detections.descriptor]);
                        descriptor.personData = person; // Attach full data to the descriptor
                        descriptors.push(descriptor);
                    } else {
                        console.warn(`រកមិនឃើញផ្ទៃមុខក្នុងរូបភាពសម្រាប់អត្តលេខ៖ ${person.id}`);
                    }
                } catch (e) {
                    console.error(`មិនអាចទាញយករូបភាពសម្រាប់អត្តលេខ៖ ${person.id}`, e);
                }
                processedCount++;
                updateStatus(`កំពុងដំណើរការ ${processedCount}/${relevantData.length} នាក់...`);
            }
            return descriptors;
        }

        function recognizeFaces(labeledFaceDescriptors) {
            if (labeledFaceDescriptors.length === 0) {
                 console.error("គ្មានទិន្នន័យផ្ទៃមុខយោង មិនអាចចាប់ផ្តើមការសម្គាល់បានទេ");
                 updateStatus("មានបញ្ហា​កើតឡើង៖ គ្មានទិន្នន័យផ្ទៃមុខយោង");
                 return;
            }
            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55); // Adjust threshold if needed
            const canvas = overlay;
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            let lastFoundId = null;
            let foundTimeout;

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                if (resizedDetections.length > 0) {
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    
                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        const personId = result.label;
                        const drawBox = new faceapi.draw.DrawBox(box, { 
                            label: personId === 'unknown' ? 'មិនស្គាល់' : personId,
                            boxColor: personId === 'unknown' ? 'red' : 'green'
                        });
                        drawBox.draw(canvas);

                        if (personId !== 'unknown' && personId !== lastFoundId) {
                            lastFoundId = personId;
                            
                            // Find the full data for the matched person
                            const matchedDescriptor = labeledFaceDescriptors.find(ld => ld.label === personId);
                            if (matchedDescriptor && matchedDescriptor.personData) {
                                displayPersonInfo(matchedDescriptor.personData);
                            }
                            
                            // Reset after a few seconds to allow for new scans
                            clearTimeout(foundTimeout);
                            foundTimeout = setTimeout(() => {
                                lastFoundId = null;
                                resetInfoDisplay();
                            }, 5000);
                        }
                    });
                } else {
                     // If no faces are detected, and someone was previously found, reset the display
                     if(lastFoundId) {
                        lastFoundId = null;
                        clearTimeout(foundTimeout);
                        resetInfoDisplay();
                     }
                }
            }, 200);
        }

        function displayPersonInfo(person) {
            placeholder.classList.add('hidden');
            infoCard.classList.remove('hidden', 'animate-pulse');
            
            resultContainer.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg">
                    <h3 class="font-bold text-2xl mb-4 text-center">${person.name || 'N/A'}</h3>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-md">
                        <strong>អត្តលេខ:</strong>             <span>${person.id || 'N/A'}</span>
                        <strong>ភេទ:</strong>                   <span>${person.gender || 'N/A'}</span>
                        <strong>ផ្នែកការងារ:</strong>       <span>${person.department || 'N/A'}</span>
                        <strong>ថ្នាក់រៀន:</strong>           <span>${person.class || 'N/A'}</span>
                        <strong>លេខតុ:</strong>                 <span>${person.table || 'N/A'}</span>
                    </div>
                </div>
            `;
        }

        function resetInfoDisplay() {
            resultContainer.innerHTML = ''; // Clear previous info
            resultContainer.appendChild(placeholder);
            resultContainer.appendChild(infoCard); // re-add skeleton card
            placeholder.classList.remove('hidden');
            infoCard.classList.add('hidden');
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (video.readyState) {
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(overlay, displaySize);
            }
        });

    </script>
</body>
</html>

