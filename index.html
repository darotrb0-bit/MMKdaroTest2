<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធសម្គាល់ផ្ទៃមុខ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- face-api.js library -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <style>
        /* Custom styles for the loader and overall layout */
        body {
            font-family: 'Kantumruy Pro', sans-serif; /* Using a Khmer font */
            background-color: #111827; /* bg-gray-900 */
        }
        #loader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(17, 24, 39, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            transition: opacity 0.5s ease-out;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
    <!-- Google Font for Khmer -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto text-center">
        <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-2 sm:mb-4">ប្រព័ន្ធស្កេន និងសម្គាល់ផ្ទៃមុខ</h1>
        <p class="text-gray-400 mb-4 sm:mb-6">សូមដាក់មុខរបស់អ្នកឱ្យចំកាមេរ៉ា ដើម្បីចាប់ផ្តើមស្កេន</p>

        <!-- Video and Canvas container -->
        <div id="video-container" class="relative w-full max-w-2xl mx-auto bg-gray-800 rounded-lg shadow-lg overflow-hidden border-2 border-gray-700" style="aspect-ratio: 4 / 3;">
            <video id="video" class="w-full h-full object-cover" autoplay muted playsinline></video>
            
            <!-- Loader Overlay -->
            <div id="loader">
                <div class="text-center">
                    <div class="spinner mx-auto mb-4"></div>
                    <p id="loader-text" class="text-lg">កំពុងដំណើរការម៉ូដែល...</p>
                </div>
            </div>
        </div>

        <!-- Information Display -->
        <div id="info-container" class="mt-8 w-full max-w-2xl mx-auto p-4 sm:p-6 bg-gray-800 rounded-lg shadow-lg border border-gray-700">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 border-b border-gray-600 pb-2">ព័ត៌មានលម្អិត</h2>
            <div id="info-content" class="text-left grid grid-cols-1 md:grid-cols-2 gap-4 text-base sm:text-lg">
                <!-- Data will be populated here -->
                 <p id="status" class="text-yellow-400 md:col-span-2">ត្រៀមខ្លួនស្កេន...</p>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const infoContent = document.getElementById('info-content');
        const statusElement = document.getElementById('status');
        
        // Google Sheet Configuration
        const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const SHEET_NAME = 'DIList';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

        // Load all necessary models from face-api.js
        async function loadModels() {
            // Using the standard NPM package path for models for better reliability
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
                ]);
            } catch (error) {
                console.error("Error loading models:", error);
                loaderText.innerText = "Error loading models. Please refresh.";
            }
        }

        // Start webcam stream
        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
            } catch (err) {
                console.error("Camera access error:", err);
                loaderText.innerText = "មិនអាចចូលប្រើកាមេរ៉ាបានទេ។ សូមអនុញ្ញាតឱ្យប្រើប្រាស់។";
                loader.querySelector('.spinner').style.display = 'none';
            }
        }

        // Fetch data from Google Sheet, load images, and create face descriptors
        async function loadLabeledImages() {
            loaderText.innerText = 'កំពុងទាញយកទិន្នន័យ...';
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                // Parse CSV text: Remove quotes and split into lines, then skip header rows (assuming data starts at row 9)
                const rows = csvText.replace(/"/g, '').split('\n').slice(8);

                const labelsData = rows.map(row => {
                    const columns = row.split(',');
                    if (columns.length > 26 && columns[26]) { // Check if URL column exists
                        return {
                            id: columns[4],      // អត្តលេខ E
                            name: columns[11],     // ឈ្មោះ L
                            gender: columns[13],   // ភេទ N
                            department: columns[18], // ផ្នែកការងារ S
                            desk: columns[7],      // លេខតុ H
                            class: columns[17],    // ថ្នាក់រៀន R
                            imageUrl: columns[26]  // រូបថតយោង AA
                        };
                    }
                    return null;
                }).filter(Boolean); // Filter out null values

                if (labelsData.length === 0) {
                     loaderText.innerText = "រកមិនឃើញទិន្នន័យរូបភាពក្នុង Google Sheet ទេ។";
                     return [];
                }

                loaderText.innerText = `រកឃើញ ${labelsData.length} ទិន្នន័យ។ កំពុងដំណើរការរូបភាព...`;
                
                return Promise.all(
                    labelsData.map(async (data) => {
                        const descriptions = [];
                        try {
                            // Using a CORS proxy to prevent cross-origin issues with some image hosts
                            const proxyUrl = 'https://api.allorigins.win/raw?url=';
                            const imageUrl = data.imageUrl.startsWith('http') ? data.imageUrl : 'https://' + data.imageUrl;
                            const img = await faceapi.fetchImage(`${proxyUrl}${encodeURIComponent(imageUrl)}`);
                            
                            const detections = await faceapi.detectSingleFace(img)
                                .withFaceLandmarks()
                                .withFaceDescriptor();
                            
                            if (detections) {
                                descriptions.push(detections.descriptor);
                                return new faceapi.LabeledFaceDescriptors(JSON.stringify(data), descriptions);
                            }
                        } catch (e) {
                            console.error(`Error processing image for ${data.name}: ${data.imageUrl}`, e);
                        }
                        return null;
                    })
                ).then(results => results.filter(Boolean)); // Filter out any null results from failed image processing

            } catch (error) {
                console.error("Error fetching or parsing sheet data:", error);
                loaderText.innerText = "មានបញ្ហាក្នុងការទាញយកទិន្នន័យពី Google Sheet។";
                return [];
            }
        }

        // Main function to run everything
        async function run() {
            await loadModels();
            await startVideo();
        }

        video.addEventListener('play', async () => {
            const labeledFaceDescriptors = await loadLabeledImages();
            
            if (labeledFaceDescriptors.length === 0) {
                 loaderText.innerText = "មិនអាចដំណើរការបានទេ ដោយសារគ្មានទិន្នន័យយោង។";
                 return;
            }

            const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5); // Confidence threshold

            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);

            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('video-container').append(canvas);
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            let lastMatch = null;
            let lastMatchTime = 0;

            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withFaceDescriptors();
                
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                if (resizedDetections.length === 0) {
                    if (document.getElementById('status')) {
                        document.getElementById('status').textContent = 'រកមិនឃើញផ្ទៃមុខ...';
                    }
                    if (lastMatch) {
                       infoContent.innerHTML = `<p id="status" class="text-yellow-400 md:col-span-2">ត្រៀមខ្លួនស្កេន...</p>`;
                       lastMatch = null;
                    }
                    return;
                }

                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                
                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    let label = result.toString();
                    let color = 'red';

                    if (label.includes('unknown')) {
                        label = 'មិនស្គាល់';
                         if (document.getElementById('status')) {
                            document.getElementById('status').textContent = 'រកឃើញផ្ទៃមុខ ប៉ុន្តែមិនស្គាល់អត្តសញ្ញាណ។';
                        }
                    } else {
                        color = 'green';
                        const data = JSON.parse(result.label);
                        label = data.name;
                        
                        // Update info only if it's a new match or after 5 seconds
                        const now = Date.now();
                        if (lastMatch?.id !== data.id || now - lastMatchTime > 5000) {
                             lastMatch = data;
                             lastMatchTime = now;
                             
                             infoContent.innerHTML = `
                                <div class="md:col-span-2 mb-2"><strong class="text-green-400">ស្កេនបានជោគជ័យ!</strong></div>
                                <p><strong>អត្តលេខ:</strong> <span class="text-blue-300">${data.id || 'N/A'}</span></p>
                                <p><strong>ឈ្មោះ:</strong> <span class="text-blue-300">${data.name || 'N/A'}</span></p>
                                <p><strong>ភេទ:</strong> <span class="text-blue-300">${data.gender || 'N/A'}</span></p>
                                <p><strong>លេខតុ:</strong> <span class="text-blue-300">${data.desk || 'N/A'}</span></p>
                                <p><strong>ផ្នែក:</strong> <span class="text-blue-300">${data.department || 'N/A'}</span></p>
                                <p><strong>ថ្នាក់:</strong> <span class="text-blue-300">${data.class || 'N/A'}</span></p>
                             `;
                        }
                    }

                    const drawBox = new faceapi.draw.DrawBox(box, { label, boxColor: color });
                    drawBox.draw(canvas);
                });

            }, 200); // Scan every 200ms
        });

        // Initialize the application
        run();

    </script>
</body>
</html>

