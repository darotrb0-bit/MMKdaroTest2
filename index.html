<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធស្វែងរកព័ត៌មាននិស្សិត</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        @property --angle {
          syntax: '<angle>';
          initial-value: 0deg;
          inherits: false;
        }

        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #000000;
            color: #a3e635; /* Lime-300 */
            overflow: hidden;
        }
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        #matrix-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.5;
        }
        .hacker-card {
            background-color: rgba(10, 20, 10, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 25px rgba(0, 255, 0, 0.15), inset 0 0 25px rgba(0, 255, 0, 0.1);
            animation: pulse-glow 4s infinite alternate;
        }
        .hacker-btn {
            border: 1px solid #4ade80;
            color: #4ade80;
            box-shadow: 0 0 5px #4ade80;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .hacker-btn:hover {
            background-color: #4ade80;
            color: #000000;
            box-shadow: 0 0 15px #4ade80, 0 0 25px #4ade80;
            transform: translateY(-3px);
        }
        .hacker-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
        }
        .hacker-btn:hover::before {
            transform: translate(-50%, -50%) scale(1);
        }
        .hacker-input {
            background-color: rgba(0, 15, 0, 0.8);
            border: 1px solid rgba(0, 255, 0, 0.3);
            color: #bef264;
        }
        .hacker-input:focus {
            outline: none;
            border-color: #86efac;
            box-shadow: 0 0 10px #86efac;
        }
        .glitch {
            position: relative; color: #86efac; animation: glitch-skew 1s infinite linear alternate-reverse;
        }
        .glitch::before, .glitch::after {
            content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .glitch::before {
            left: 2px; text-shadow: -2px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim 5s infinite linear alternate-reverse;
        }
        .glitch::after {
            left: -2px; text-shadow: -2px 0 #00ff00, 2px 2px #ff00c1; clip: rect(85px, 450px, 90px, 0); animation: glitch-anim-2 5s infinite linear alternate-reverse;
        }
        @keyframes glitch-anim { 0%, 100% { clip: rect(46px, 9999px, 23px, 0); } 2% { clip: rect(42px, 9999px, 69px, 0); } 4% { clip: rect(46px, 9999px, 23px, 0); } 6% { clip: rect(11px, 9999px, 9px, 0); } 8% { clip: rect(46px, 9999px, 23px, 0); } }
        @keyframes glitch-anim-2 { 0%, 100% { clip: rect(11px, 9999px, 9px, 0); } 3% { clip: rect(74px, 9999px, 59px, 0); } 5% { clip: rect(11px, 9999px, 9px, 0); } 7% { clip: rect(86px, 9999px, 8px, 0); } 9% { clip: rect(11px, 9999px, 9px, 0); } }
        @keyframes glitch-skew { 0%, 20%, 100% { transform: skew(0deg); } 5% { transform: skew(1deg); } 10% { transform: skew(0deg); } 15% { transform: skew(-1deg); } }
        @keyframes pulse-glow {
            from { border-color: rgba(0, 255, 0, 0.3); box-shadow: 0 0 25px rgba(0, 255, 0, 0.15), inset 0 0 25px rgba(0, 255, 0, 0.1); }
            to { border-color: rgba(134, 239, 172, 0.7); box-shadow: 0 0 35px rgba(134, 239, 172, 0.3), inset 0 0 35px rgba(134, 239, 172, 0.1); }
        }
        #cameraModal::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.3), rgba(0,0,0,0.3) 1px, transparent 1px, transparent 4px);
            pointer-events: none; z-index: 51;
        }
        .scanline {
            position: absolute; left: 0; width: 100%; height: 3px; background: #0f0;
            box-shadow: 0 0 10px #0f0, 0 0 20px #0f0; animation: scan 2s linear infinite; z-index: 52;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes modal-fade-in { 
            from { opacity: 0; transform: translateY(30px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        .boot-sequence { opacity: 0; animation: fadeIn 1s ease-out forwards; }
        .data-line { opacity: 0; transition: opacity 0.5s ease; }
        .sci-fi-modal-bg {
             background:
                linear-gradient(to top, rgba(0, 255, 0, 0.08) 1px, transparent 1px),
                linear-gradient(to right, rgba(0, 255, 0, 0.08) 1px, transparent 1px),
                linear-gradient(rgba(10, 20, 10, 0.97), rgba(10, 20, 10, 0.97)),
                url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23053005' fill-opacity='0.2'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h16v9h1v-9h9v9h1v-9h9v9h1v-9h9v9h1v-9h9v9h1v-9h9v9h1v-9h9v9h1v-9h9v9h1v-9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-9v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10-9v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-9v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10-9v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10-9v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9zm10 0v-9h9v9h-9z'/%3E%3Cpath d='M6 5V0h1v5h94V0h1v5h-1v90h1v1H6v-1h94V5H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
             background-size: 25px 25px, 25px 25px, auto, auto;
        }
        .animated-border-box {
            position: relative; z-index: 1; padding: 2px;
        }
         .animated-border-box::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #081108; z-index: -1;
        }
        .animated-border-box-photo {
            position: relative; z-index: 1; padding: 2px;
        }
        .animated-border-box-photo::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: conic-gradient(from var(--angle), transparent 70%, #ffffff, transparent);
            border-radius: inherit; animation: spin 5s linear infinite; z-index: -2;
            filter: blur(8px) brightness(1.5);
        }
         .animated-border-box-photo::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #061406; border-radius: inherit; z-index: -1;
        }
        @keyframes spin { to { --angle: 360deg; } }
        .data-scramble { position: relative; }
        .data-label { color: #86efac; text-shadow: 0 0 3px rgba(134, 239, 172, 0.4); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.1em; }
        .corner-brackets {
            position: absolute; width: 25px; height: 25px; 
            border-style: solid;
            animation: pulse-corners-glow 2.5s infinite ease-in-out;
        }
        .corner-brackets.top-left { top: -4px; left: -4px; border-width: 3px 0 0 3px; }
        .corner-brackets.top-right { top: -4px; right: -4px; border-width: 3px 3px 0 0; animation-delay: 0.2s; }
        .corner-brackets.bottom-left { bottom: -4px; left: -4px; border-width: 0 0 3px 3px; animation-delay: 0.4s; }
        .corner-brackets.bottom-right { bottom: -4px; right: -4px; border-width: 0 3px 3px 0; animation-delay: 0.6s; }
        .data-scramble, .text-yellow-300, .text-yellow-500 { text-shadow: 0 0 8px rgba(250, 204, 21, 0.5); }
        
        @keyframes pulse-corners-glow {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
                border-color: #ca8a04;
                box-shadow: 0 0 6px rgba(250, 204, 21, 0.4);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
                border-color: #fde047;
                box-shadow: 0 0 16px rgba(250, 204, 21, 0.8);
            }
        }
        
        /* NEW STYLES for the redesigned info modal */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .info-block {
            background-color: rgba(0, 255, 0, 0.05);
            padding: 0.75rem;
            border-left: 3px solid #4ade80;
        }
        .info-label {
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: #86efac;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }
        .info-value {
            font-family: 'Fira Code', monospace;
            color: #bef264;
            text-shadow: 0 0 5px rgba(190, 242, 100, 0.5);
        }
        .hr-deco {
            border: none;
            height: 1px;
            background-image: linear-gradient(to right, transparent, rgba(134, 239, 172, 0.5), transparent);
            margin: 1rem 0;
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <canvas id="matrix-background"></canvas>

    <div id="main-content" class="w-full max-w-md mx-auto z-10 boot-sequence" style="animation-delay: 2.5s;">
        <div class="hacker-card shadow-2xl rounded-2xl p-6">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold glitch" data-text="ស្វែងរកព័ត៌មាននិស្សិត">ស្វែងរកព័ត៌មាននិស្សិត</h1>
                <p class="text-gray-400 mt-2 font-mono text-sm tracking-wider">[បញ្ចូលអត្តលេខ ឬប្រើរូបថតដើម្បីស្វែងរក]</p>
            </div>

            <!-- Search Form -->
            <div class="space-y-4">
                <div class="flex space-x-2">
                    <input type="text" id="studentIdInput" class="hacker-input flex-grow text-sm rounded-lg block w-full p-2.5 font-mono" placeholder="ID: DI0001..." required>
                    <button id="searchButton" class="hacker-btn font-medium rounded-lg text-sm px-5 py-2.5 text-center"><i class="fa fa-search"></i></button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <button id="scanFaceButton" class="hacker-btn w-full font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center justify-center space-x-2"><i class="fa-solid fa-camera"></i><span>ស្កេនមុខ</span></button>
                    <button id="uploadImageButton" class="hacker-btn w-full font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center justify-center space-x-2"><i class="fa-solid fa-upload"></i><span>Upload រូប</span></button>
                    <input type="file" id="imageUploadInput" accept="image/*" class="hidden">
                </div>
            </div>

            <!-- Status/Message Area -->
            <div id="statusMessage" class="text-center text-yellow-400 min-h-[24px] my-4 font-mono text-xs"></div>

        </div>
        <footer class="text-center text-gray-500 text-xs mt-4 font-mono"><p>DI Student Information System &copy; 2025 // SECURE TERMINAL</p></footer>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 w-full h-full z-50 hidden items-center justify-center bg-black/80">
        <div class="scanline"></div>
        <video id="video" autoplay muted playsinline class="max-w-full max-h-full"></video>
        <canvas id="overlay" class="absolute top-0 left: 0"></canvas>
        <button id="closeCameraModalButton" class="absolute top-4 right-4 text-white text-3xl z-50 hover:text-green-400 transition"><i class="fa-solid fa-xmark"></i></button>
        <button id="switchCameraButton" class="absolute bottom-4 left-4 text-white bg-black/50 p-3 rounded-full z-50 hover:bg-green-400/50 transition"><i class="fa-solid fa-camera-rotate"></i></button>
        <div id="scanStatus" class="absolute bottom-4 font-mono text-white bg-black/50 px-4 py-2 rounded-lg">...</div>
    </div>
    
    <!-- Info Modal -->
    <div id="infoModal" class="fixed inset-0 w-full h-full z-50 hidden items-center justify-center bg-black/90 p-4" style="animation: modal-fade-in 0.5s ease-out;">
        <div id="modal-container" class="relative w-full max-w-2xl">
             <div class="animated-border-box">
                  <div class="sci-fi-modal-bg w-full p-6 relative">
                    <div class="corner-brackets top-left"></div><div class="corner-brackets top-right"></div>
                    <div class="corner-brackets bottom-left"></div><div class="corner-brackets bottom-right"></div>
                    
                    <div class="flex justify-between items-start border-b border-yellow-800/50 pb-2 mb-4">
                        <h2 class="text-lg font-bold text-yellow-300 glitch" data-text="SUBJECT FILE">SUBJECT FILE</h2>
                        <div class="text-xs font-mono text-yellow-500 pt-1">_ID: <span id="modal-student-id"></span></div>
                    </div>
                    <div id="infoModalContent"></div>
                </div>
            </div>
        </div>
    </div>


<script>
    // --- Matrix Background Effect ---
    const canvas = document.getElementById('matrix-background');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    let latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890';
    let fontSize = 16;
    let columns = canvas.width / fontSize;
    let rainDrops = Array.from({ length: columns }).fill(1);
    
    function drawMatrix() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0f0';
        ctx.font = `${fontSize}px monospace`;
        rainDrops.forEach((y, i) => {
            const text = latin.charAt(Math.floor(Math.random() * latin.length));
            ctx.fillText(text, i * fontSize, y * fontSize);
            if (y * fontSize > canvas.height && Math.random() > 0.975) {
                rainDrops[i] = 0;
            }
            rainDrops[i]++;
        });
    };
    // PERFORMANCE OPTIMIZATION: Reduced the frequency of the matrix animation
    setInterval(drawMatrix, 70); 
    window.addEventListener('resize', () => { 
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        columns = canvas.width / fontSize;
        rainDrops = Array.from({ length: columns }).fill(1);
    });

    // --- Sound Engine (Upgraded) ---
    let soundsReady = false;
    const actionSound = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, detune: 0, oscillator: { type: "sine" }, envelope: { attack: 0.001, decay: 0.1, sustain: 0.01, release: 0.1 }, modulation: { type: "square" }, modulationEnvelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 } }).toDestination();
    const typingSound = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.001, decay: 0.05, sustain: 0 } }).toDestination();
    const successSound = new Tone.PolySynth(Tone.FMSynth, { volume: -8, harmonicity: 1.5, modulationIndex: 5, envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();
    const errorSound = new Tone.FMSynth({ harmonicity: 1, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.4, sustain: 0, release: 0.1 }, modulation: { type: "sawtooth" } }).toDestination();
    
    function playSound(sound, note = null, duration = '16n') {
        if (!soundsReady) return;
        if (note) {
            if(Array.isArray(note)) sound.triggerAttackRelease(note, duration);
            else sound.triggerAttackRelease(note, duration);
        } else sound.triggerAttackRelease(duration);
    }
    document.body.addEventListener('click', async () => {
        if (!soundsReady) {
            await Tone.start();
            soundsReady = true;
            console.log("Audio context started.");
        }
    });


    // --- Configuration & DOM Elements ---
    const API_KEY = 'AIzaSyC6E9ON7DsgkMZEc6obtWehyqzGWwd_EII'; // WARNING: Exposing API keys on the client-side is a security risk.
    const SHEET_ID = '1_Kgl8UQXRsVATt_BOHYQjVWYKkRIBA12R-qnsBoSUzc';
    const SHEET_NAME = 'បញ្ជឺឈ្មោះរួម';
    const DATA_RANGE = 'C9:AA';
    const FACEAPI_MODELS_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
    const TINY_FACE_DETECTOR_OPTIONS = new faceapi.TinyFaceDetectorOptions({ inputSize: 224 });

    const studentIdInput = document.getElementById('studentIdInput');
    const statusMessage = document.getElementById('statusMessage');
    const mainContent = document.getElementById('main-content');
    const searchButton = document.getElementById('searchButton');
    const scanFaceButton = document.getElementById('scanFaceButton');
    const uploadImageButton = document.getElementById('uploadImageButton');
    const imageUploadInput = document.getElementById('imageUploadInput');
    const cameraModal = document.getElementById('cameraModal');
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const closeCameraModalButton = document.getElementById('closeCameraModalButton');
    const switchCameraButton = document.getElementById('switchCameraButton');
    const scanStatus = document.getElementById('scanStatus');
    const infoModal = document.getElementById('infoModal');
    const infoModalContent = document.getElementById('infoModalContent');
    const modalStudentId = document.getElementById('modal-student-id');

    let studentDataCache = [];
    let faceMatcher = null;
    let currentStream;
    let scanInterval;
    let isDetecting = false; // Flag to prevent overlapping detections
    let facingMode = 'environment';

    const COL_INDEX = { GENERATION: 0, YEAR: 1, ID: 2, GROUP: 4, NAME_KHMER: 9, NAME_LATIN: 10, GENDER: 11, CLASS: 15, DEPARTMENT: 16, IMAGE_URL: 24 };
    
    // CORRECTED TYPEWRITER EFFECT
    function typewriterEffect(element, text, speed = 25, onComplete = () => {}) {
        element.textContent = '';
        let i = 0;
        const typeInterval = setInterval(() => {
            if (i < text.length) {
                playSound(typingSound, null, '64n');
                element.textContent += text.charAt(i);
                i++;
            } else {
                clearInterval(typeInterval);
                if (onComplete) onComplete();
            }
        }, speed);
    }

    // Function to fetch with a timeout
    async function fetchWithTimeout(resource, options = {}) {
        const { timeout = 10000 } = options; // 10 seconds timeout
        
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);

        const response = await fetch(resource, {
            ...options,
            signal: controller.signal  
        });
        clearTimeout(id);
        return response;
    }
    
    async function runBootSequence() {
        mainContent.style.opacity = '0';
        const bootMessages = [
            { text: 'កំពុងចាប់ផ្តើមប្រព័ន្ធ...', delay: 100 },
            { text: 'កំពុងដំណើរការម៉ូឌុល...', delay: 500 },
            { text: 'កំពុងភ្ជាប់ទៅកាន់ម៉ាស៊ីនមេ...', delay: 800 },
            { text: 'ការតភ្ជាប់មានសុវត្ថិភាព. ប្រព័ន្ធរួចរាល់', delay: 1000 }
        ];
        let delay = 0;
        for (const msg of bootMessages) {
            setTimeout(() => typewriterEffect(statusMessage, msg.text), delay);
            delay += msg.delay;
        }
        setTimeout(() => mainContent.style.opacity = '1', delay);
    }

    window.addEventListener('load', async () => {
        runBootSequence();
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODELS_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(FACEAPI_MODELS_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(FACEAPI_MODELS_URL),
        ]);
        await fetchAndPrepareData();
    });

    async function fetchAndPrepareData() { 
        typewriterEffect(statusMessage, 'កំពុងតភ្ជាប់ទៅមូលដ្ឋានទិន្នន័យ...');
        try {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!${DATA_RANGE}?key=${API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ERROR ${response.status}`);
            const data = await response.json();
            
            if (!data.values || data.values.length === 0) {
                typewriterEffect(statusMessage, 'កំហុស: រកមិនឃើញទិន្នន័យក្នុងមូលដ្ឋានទិន្នន័យទេ');
                playSound(errorSound, 'C2', '4n');
                return;
            }
            studentDataCache = data.values;
            typewriterEffect(statusMessage, 'ការតភ្ជាប់ជោគជ័យ. ទិន្នន័យបានធ្វើសមកាលកម្ម');
            
            await createFaceMatcher();
        } catch (error) {
            console.error('Failed to fetch data:', error);
            typewriterEffect(statusMessage, 'ការតភ្ជាប់បានបរាជ័យ. សូមពិនិត្យមើល Console');
            playSound(errorSound, 'C2', '4n');
        }
    }

    async function createFaceMatcher() {
        if (studentDataCache.length === 0) return;
        const labeledFaceDescriptors = [];
        let processedCount = 0;
        const studentsWithImages = studentDataCache.filter(row => row[COL_INDEX.IMAGE_URL]);
        const totalImages = studentsWithImages.length;

        for (const row of studentsWithImages) {
            processedCount++;
            const label = row[COL_INDEX.ID];
            const imageUrl = row[COL_INDEX.IMAGE_URL];
            const percent = Math.round((processedCount / totalImages) * 100);
            statusMessage.textContent = `កំពុងចងក្រងទិន្នន័យ: ${processedCount}/${totalImages} [${percent}%]`;
            
            if (label && imageUrl) {
                try {
                    await new Promise(resolve => setTimeout(resolve, 100)); 
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(imageUrl)}`;
                    const response = await fetchWithTimeout(proxyUrl, { timeout: 10000 });
                    if(!response.ok) throw new Error(`Fetch failed with status ${response.status}`);
                    const blob = await response.blob();
                    const img = await faceapi.bufferToImage(blob);

                    const detections = await faceapi.detectSingleFace(img, TINY_FACE_DETECTOR_OPTIONS).withFaceLandmarks().withFaceDescriptor();
                    if (detections) {
                        labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(label, [detections.descriptor]));
                    }
                } catch (e) { 
                    console.error(`Could not process image for ${label} (Skipped): ${imageUrl}`, e);
                }
            }
        }

        if (labeledFaceDescriptors.length > 0) {
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
            typewriterEffect(statusMessage, 'ប្រព័ន្ធរួចរាល់. រង់ចាំការបញ្ជា');
            playSound(successSound, ['C5', 'E5', 'G5'], '8n');
        } else {
            typewriterEffect(statusMessage, 'ការចងក្រងទិន្នន័យបានបរាជ័យ. សូមពិនិត្យ URL រូបភាព');
            playSound(errorSound, 'C2', '4n');
        }
    }
    
    const scrambleChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890*#%&_';
    function scrambleText(element, final_text, duration = 500) {
        let i = 0;
        const interval = setInterval(() => {
            element.textContent = final_text.split('').map((char, index) => {
                if (index < i) return final_text[index];
                if (char === ' ') return ' ';
                return scrambleChars[Math.floor(Math.random() * scrambleChars.length)];
            }).join('');

            if (i >= final_text.length) {
                clearInterval(interval);
                element.textContent = final_text;
            }
            i += final_text.length / (duration / 50);
        }, 50);
    }

    function displayStudentInfo(row) {
        playSound(successSound, ['C5', 'G5'], '8n'); // Sound on modal display
        modalStudentId.textContent = row[COL_INDEX.ID] || 'N/A';
        infoModalContent.innerHTML = `
            <div class="flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6">
                <div class="animated-border-box-photo mx-auto md:mx-0">
                    <img src="${row[COL_INDEX.IMAGE_URL]}" onerror="this.src='https://placehold.co/144x160/0a140a/a3e635?text=NO+IMAGE';" alt="Student Photo" class="w-36 h-40 object-cover">
                </div>
                <div class="flex-grow w-full space-y-3">
                    <div class="data-line">
                        <p class="data-label">SUBJECT NAME</p>
                        <h3 class="data-scramble text-2xl text-green-300 font-bold" data-final="${row[COL_INDEX.NAME_KHMER] || 'N/A'}"></h3>
                        <p class="data-scramble text-lg font-mono text-green-400" data-final="${row[COL_INDEX.NAME_LATIN] || 'N/A'}"></p>
                    </div>

                    <hr class="hr-deco data-line">

                    <div class="info-grid">
                        <div class="info-block data-line">
                            <p class="info-label">Biometric Data</p>
                            <p class="info-value data-scramble" data-final="Gender: ${row[COL_INDEX.GENDER] || 'N/A'}"></p>
                        </div>
                        <div class="info-block data-line">
                            <p class="info-label">Cohort Info</p>
                            <p class="info-value data-scramble" data-final="Group: ${row[COL_INDEX.GROUP] || 'N/A'}"></p>
                            <p class="info-value data-scramble" data-final="Gen: ${row[COL_INDEX.GENERATION] || 'N/A'} | Year: ${row[COL_INDEX.YEAR] || 'N/A'}"></p>
                        </div>
                    </div>
                    <div class="info-block data-line w-full">
                        <p class="info-label">Academic Record</p>
                        <p class="info-value data-scramble" data-final="Department: ${row[COL_INDEX.DEPARTMENT] || 'N/A'}"></p>
                        <p class="info-value data-scramble" data-final="Class: ${row[COL_INDEX.CLASS] || 'N/A'}"></p>
                    </div>
                </div>
            </div>`;
        infoModal.classList.remove('hidden');
        infoModal.classList.add('flex');
        
        const lines = infoModalContent.querySelectorAll('.data-line');
        lines.forEach((line, index) => {
            setTimeout(() => {
                line.style.opacity = '1';
                const scrambles = line.querySelectorAll('.data-scramble');
                scrambles.forEach(el => {
                    scrambleText(el, el.dataset.final);
                    playSound(typingSound, null, '64n');
                });
            }, index * 300); 
        });
    }

    function findStudentById(idToSearch) {
        if (!idToSearch) {
            typewriterEffect(statusMessage, 'កំហុសបញ្ជា: សូមបញ្ចូលអត្តលេខ');
            playSound(errorSound, 'C2', '4n');
            return;
        }
        const targetId = idToSearch.trim().toUpperCase();
        const studentRow = studentDataCache.find(row => row[COL_INDEX.ID] && row[COL_INDEX.ID].toUpperCase() === targetId);

        if (studentRow) {
            typewriterEffect(statusMessage, `ស្វែងរក​ឃើញ: កំពុងបង្ហាញទិន្នន័យសម្រាប់ ${targetId}`);
            // Sound is now played inside displayStudentInfo
            displayStudentInfo(studentRow);
        } else {
            typewriterEffect(statusMessage, `ស្វែងរក​មិន​ឃើញ: អត្តលេខ "${idToSearch}" មិនមានក្នុងប្រព័ន្ធ`);
            playSound(errorSound, 'E2', '4n');
        }
    }
    
    async function startCamera(mode) {
        try {
            if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); }
            currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
            video.srcObject = currentStream;
            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');
        } catch (err) {
            console.error("Error accessing camera:", err);
            typewriterEffect(statusMessage, 'ការចូលប្រើកាមេរ៉ាត្រូវបានបដិសេធ');
            playSound(errorSound, 'C2', '4n');
        }
    }

    video.addEventListener('play', () => {
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(overlay, displaySize);
        scanStatus.textContent = "កំពុងស្វែងរកគោលដៅ...";

        scanInterval = setInterval(async () => {
            // PERFORMANCE OPTIMIZATION: Prevent new detections from starting if one is already running
            if (!faceMatcher || isDetecting) return;
            isDetecting = true;
            
            const detections = await faceapi.detectSingleFace(video, TINY_FACE_DETECTOR_OPTIONS).withFaceLandmarks().withFaceDescriptor();
            
            if (detections) {
                scanStatus.textContent = "ចាប់បានគោលដៅ, កំពុងផ្ទៀងផ្ទាត់...";
                const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
                
                if (bestMatch && bestMatch.label !== 'unknown') {
                    const studentRow = studentDataCache.find(row => row[COL_INDEX.ID] === bestMatch.label);
                    if (studentRow) {
                        typewriterEffect(statusMessage, `រកឃើញមុខត្រូវគ្នា: ${bestMatch.label}`);
                        // Sound is now played inside displayStudentInfo
                        displayStudentInfo(studentRow);
                        stopCamera();
                    }
                } else { 
                    scanStatus.textContent = "មិនស្គាល់គោលដៅ. កំពុងព្យាយាមម្តងទៀត..."; 
                }
            } else { 
                scanStatus.textContent = "កំពុងស្វែងរកគោលដៅ..."; 
            }
            isDetecting = false; // Allow the next detection to start
        }, 500);
    });
    
    function stopCamera() {
        if (currentStream) { currentStream.getTracks().forEach(track => track.stop()); }
        clearInterval(scanInterval);
        cameraModal.classList.add('hidden');
        cameraModal.classList.remove('flex');
    }
    
    async function handleImageUpload(event) {
        if (!faceMatcher) { typewriterEffect(statusMessage, 'ប្រព័ន្ធកំពុងរវល់. សូមរង់ចាំ'); return; }
        const file = event.target.files[0];
        if (!file) return;

        typewriterEffect(statusMessage, 'កំពុងវិភាគរូបភាព...');
        
        const image = await faceapi.bufferToImage(file);
        
        const canvas = document.createElement('canvas');
        const max_size = 720;
        let width = image.width, height = image.height;
        if (width > height) {
            if (width > max_size) { height *= max_size / width; width = max_size; }
        } else {
            if (height > max_size) { width *= max_size / height; height = max_size; }
        }
        canvas.width = width; canvas.height = height;
        canvas.getContext('2d').drawImage(image, 0, 0, width, height);

        const detections = await faceapi.detectSingleFace(canvas, TINY_FACE_DETECTOR_OPTIONS).withFaceLandmarks().withFaceDescriptor();

        if (detections) {
            const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
            if (bestMatch && bestMatch.label !== 'unknown') {
                const studentRow = studentDataCache.find(row => row[COL_INDEX.ID] === bestMatch.label);
                typewriterEffect(statusMessage, `រកឃើញមុខត្រូវគ្នា: ${bestMatch.label}`);
                displayStudentInfo(studentRow);
            } else {
                typewriterEffect(statusMessage, 'ការវិភាគបានបញ្ចប់: រកមិនឃើញមុខត្រូវគ្នា');
                playSound(errorSound, 'E2', '4n');
            }
        } else {
            typewriterEffect(statusMessage, 'ការវិភាគបានបរាជ័យ: រកមិនឃើញផ្ទៃមុខ');
            playSound(errorSound, 'C2', '4n');
        }
    }
    
    // --- Master Event Listeners ---
    searchButton.addEventListener('click', () => {
        playSound(actionSound, 'C4', '16n');
        findStudentById(studentIdInput.value);
    });
    studentIdInput.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
            playSound(actionSound, 'C4', '16n');
            findStudentById(studentIdInput.value);
        }
    });
    scanFaceButton.addEventListener('click', () => {
        playSound(actionSound, 'C4', '16n');
        startCamera(facingMode);
    });
    closeCameraModalButton.addEventListener('click', stopCamera);
    switchCameraButton.addEventListener('click', () => {
        playSound(actionSound, 'A3', '16n');
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        stopCamera();
        setTimeout(() => startCamera(facingMode), 100);
    });
    uploadImageButton.addEventListener('click', () => {
        playSound(actionSound, 'C4', '16n');
        imageUploadInput.click();
    });
    imageUploadInput.addEventListener('change', handleImageUpload);
    
    // --- MODAL CLOSING LOGIC (Double Click) ---
    function closeInfoModal() {
        playSound(actionSound, 'G3', '16n');
        infoModal.classList.add('hidden');
        infoModal.classList.remove('flex');
    }
    
    infoModal.addEventListener('dblclick', closeInfoModal);

</script>
</body>
</html>

