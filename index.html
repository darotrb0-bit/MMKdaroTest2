<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធស្កេនមុខចេញ-ចូលស្វ័យប្រវត្តិ</title>
    <!-- បញ្ចូល Tailwind CSS សម្រាប់​ការ​រចនា​រូបរាង -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- បញ្ចូល face-api.js សម្រាប់​បច្ចេកវិទ្យា​វិភាគ​ផ្ទៃមុខ -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        /* រចនា​បន្ថែម​សម្រាប់​ផ្ទុក​ទិន្នន័យ */
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3498db;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* រចនា​សម្រាប់​បញ្ជី​កត់ត្រា */
        #log-list li {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        #log-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl bg-white rounded-xl shadow-lg">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">ប្រព័ន្ធស្កេនមុខចេញ-ចូលស្វ័យប្រវត្តិ (សម្រាប់​មនុស្ស​ច្រើន​នាក់)</h1>

        <!-- បង្ហាញ​នៅ​ពេល​កំពុង​ទាញ​យក Model -->
        <div id="loading" class="flex flex-col items-center justify-center p-8">
            <div id="loader-icon" class="loader mb-4"></div>
            <p id="loading-text" class="text-gray-600 text-center">កំពុង​រៀបចំ​ប្រព័ន្ធ​... សូម​រង់ចាំ​បន្តិច!</p>
        </div>

        <!-- ផ្នែក​សំខាន់​នៃ​កម្មវិធី (លាក់​ទុក​រហូត​ដល់ Model ​ដំណើរការ​រួច) -->
        <main id="main-content" class="hidden">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- ផ្នែក​បង្ហាញ​កាមេរ៉ា -->
                <div class="flex flex-col items-center">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">កាមេរ៉ា​ស្កេន​ផ្ទាល់</h2>
                    <div class="relative w-full max-w-md rounded-lg overflow-hidden border-2 border-gray-300">
                        <video id="video" playsinline muted autoplay class="w-full h-auto"></video>
                        <canvas id="canvas" class="absolute top-0 left-0"></canvas>
                    </div>
                </div>

                <!-- ផ្នែក​បង្ហាញ​បញ្ជី​កត់ត្រា -->
                <div class="flex flex-col">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">បញ្ជី​កត់ត្រា​ការ​ចេញ-ចូល</h2>
                    <div id="log-container" class="w-full h-96 bg-gray-50 rounded-lg shadow-inner overflow-y-auto">
                        <ul id="log-list">
                            <!-- បញ្ជី​នឹង​បង្ហាញ​នៅ​ទីនេះ -->
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const loadingDiv = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const loaderIcon = document.getElementById('loader-icon');
        const mainContent = document.getElementById('main-content');
        const logList = document.getElementById('log-list');

        let checkedOutUsers = [];
        let nextUserId = 1;
        const faceMatcherThreshold = 0.5;

        function showLoadingError(title, message) {
            loaderIcon.style.display = 'none';
            loadingText.innerHTML = `
                <p class="text-red-600 font-bold text-lg">${title}</p>
                <p class="text-gray-600 mt-2">${message}</p>
            `;
        }

        async function run() {
            try {
                loadingText.textContent = 'កំពុង​ទាញយក Model AI... (អាច​ចំណាយ​ពេល​បន្តិច)';
                const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                ]);
                
                loadingText.textContent = 'Model បាន​ទាញយក​រួចរាល់! កំពុង​ត្រៀម​បើក​កាមេរ៉ា...';
                await startWebcam();
            } catch (error) {
                console.error('Failed to load models:', error);
                showLoadingError(
                    'មាន​បញ្ហា​ក្នុង​ការ​ទាញយក Model!',
                    'សូម​ពិនិត្យ​ការ​เชื่อมต่ออินเทอร์เน็ต​របស់​អ្នក ហើយ​ព្យាយាម​ផ្ទុក​ទំព័រ​ឡើងវិញ។'
                );
            }
        }

        async function startWebcam() {
            // **កែប្រែថ្មី:** ពិនិត្យ​មើល​ថា​តើ Browser ​គាំទ្រ​ការ​ប្រើ​កាមេរ៉ា​ដែរ​ឬទេ
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.error('getUserMedia() is not supported by your browser.');
                showLoadingError(
                    'Browser មិន​គាំទ្រ!',
                    'កម្មវិធី​រុករក​របស់​អ្នក​មិន​គាំទ្រ​ការ​ចូល​ប្រើ​កាមេរ៉ា​ទេ។ សូម​សាកល្បង​ប្រើ Chrome ឬ Firefox ជំនាន់​ចុងក្រោយ។'
                );
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing webcam: ", err);
                let message = 'សូម​ប្រាកដ​ថា​អ្នក​បាន​អនុញ្ញាត (Allow) ឲ្យ​គេហទំព័រ​នេះ​ប្រើប្រាស់​កាមេរ៉ា​នៅ​ក្នុង Browser។';
                
                // **កែប្រែថ្មី:** បង្ហាញ​សារ​ផ្សេង​គ្នា​អាស្រ័យ​លើ​ប្រភេទ​បញ្ហា
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    message = 'អ្នក​បាន​បដិសេធ​ការ​ចូល​ប្រើ​កាមេរ៉ា។ សូម​អនុញ្ញាត​ក្នុង​ការ​កំណត់​របស់ Browser រួច​ផ្ទុក​ទំព័រ​ឡើងវិញ។';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                     message = 'រក​មិន​ឃើញ​កាមេរ៉ា​ទេ។ សូម​ប្រាកដ​ថា​កាមេរ៉ា​របស់​អ្នក​បាន​ភ្ជាប់​ត្រឹមត្រូវ។';
                }

                showLoadingError(
                    'មិន​អាច​បើក​កាមេរ៉ា​បាន​ទេ!',
                    message
                );
            }
        }

        video.addEventListener('play', () => {
            loadingDiv.style.display = 'none';
            mainContent.classList.remove('hidden');

            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(scanFaces, 2000);
        });
        
        async function scanFaces() {
            if (video.paused || video.ended) {
                return;
            }
            const displaySize = { width: video.clientWidth, height: video.clientHeight };
            faceapi.matchDimensions(canvas, displaySize);

            const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);

            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            faceapi.draw.drawDetections(canvas, resizedDetections);
            
            if (detections.length === 0) return;

            const labeledDescriptors = checkedOutUsers.map(user => 
                new faceapi.LabeledFaceDescriptors(user.label, [user.descriptor])
            );
            const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, faceMatcherThreshold);

            for (const detection of detections) {
                const bestMatch = faceMatcher.findBestMatch(detection.descriptor);
                
                if (bestMatch.label !== 'unknown') {
                    const userLabel = bestMatch.label;
                    const logFound = Array.from(logList.children).some(li => li.textContent.includes(`${userLabel} បាន​ស្កេន​ចូល`));
                    if (!logFound) {
                        logEvent(`✅ បុគ្គលិក ${userLabel} បាន​ស្កេន​ចូល`, 'checkin');
                        checkedOutUsers = checkedOutUsers.filter(user => user.label !== userLabel);
                    }
                } else {
                    const isAlreadyCheckedOut = checkedOutUsers.some(user => 
                        faceapi.euclideanDistance(user.descriptor, detection.descriptor) < faceMatcherThreshold
                    );

                    if (!isAlreadyCheckedOut) {
                        const newUserLabel = `ID-${nextUserId}`;
                        checkedOutUsers.push({
                            label: newUserLabel,
                            descriptor: detection.descriptor
                        });
                        logEvent(`➡️ បុគ្គលិក ${newUserLabel} បាន​ស្កេន​ចេញ`, 'checkout');
                        nextUserId++;
                    }
                }
            }
        }

        function logEvent(message, type) {
            const li = document.createElement('li');
            const time = new Date().toLocaleTimeString('en-GB');
            
            li.innerHTML = `<strong>[${time}]</strong>: ${message}`;
            
            if (type === 'checkin') {
                li.className = 'text-green-700 bg-green-50';
            } else if (type === 'checkout') {
                li.className = 'text-blue-700 bg-blue-50';
            }

            logList.prepend(li);
        }

        run();
    </script>
</body>
</html>

