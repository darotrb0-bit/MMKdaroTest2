<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>កម្មវិធីស្កេនមុខនិស្សិត</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- សម្រាប់ face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            touch-action: manipulation;
        }
        #video, #canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 1rem;
        }
        #video-container {
            width: 100%;
            padding-top: 100%; /* 1:1 Aspect Ratio */
            position: relative;
            overflow: hidden;
            border-radius: 1rem;
            background-color: #333;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- បញ្ចូល Google Fonts សម្រាប់ភាសាខ្មែរ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto">
        <h1 class="text-2xl font-bold text-center mb-4 text-blue-400">ប្រព័ន្ធស្វែងរកព័ត៌មាននិស្សិត</h1>

        <!-- Loading State -->
        <div id="loading" class="text-center p-8">
            <div class="loader mx-auto"></div>
            <p id="loading-status" class="mt-4 text-gray-400">កំពុងរៀបចំម៉ូដែល AI...</p>
            <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- Scanner State -->
        <div id="scanner" class="hidden">
             <div id="video-container" class="shadow-2xl">
                <video id="video" width="720" height="720" autoplay muted playsinline></video>
                <canvas id="canvas"></canvas>
            </div>
            <p id="scanner-status" class="text-center mt-4 text-lg font-semibold text-yellow-400 animate-pulse">សូមដាក់មុខចំកាមេរ៉ា</p>
        </div>
        
        <!-- Result State -->
        <div id="result" class="hidden bg-gray-800 p-6 rounded-2xl shadow-lg transition-all duration-500">
            <div class="text-center">
                <img id="student-photo" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-blue-500 object-cover" src="https://placehold.co/128x128/334155/e2e8f0?text=Photo" alt="Student Photo">
            </div>
            <div class="space-y-3 mt-4">
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="font-semibold text-gray-400">ឈ្មោះ</span>
                    <span id="student-name" class="font-bold text-lg text-right"></span>
                </div>
                <div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg">
                    <span class="font-semibold text-gray-400">អក្សរឡាតាំង</span>
                    <span id="student-latin-name" class="font-bold text-lg text-right"></span>
                </div>
                 <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 text-sm">អត្តលេខ</p>
                        <p id="student-id" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 text-sm">ភេទ</p>
                        <p id="student-gender" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg col-span-2">
                        <p class="font-semibold text-gray-400 text-sm">ផ្នែក</p>
                        <p id="student-department" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 text-sm">ក្រុម</p>
                        <p id="student-group" class="font-bold"></p>
                    </div>
                     <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 text-sm">ថ្នាក់</p>
                        <p id="student-class" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 text-sm">ជំនាន់</p>
                        <p id="student-generation" class="font-bold"></p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="font-semibold text-gray-400 text-sm">ឆ្នាំសិក្សា</p>
                        <p id="student-year" class="font-bold"></p>
                    </div>
                </div>
            </div>
            <button id="scan-again" class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">ស្កេនម្ដងទៀត</button>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-800 text-white text-center p-4 rounded-lg"></div>

    </div>

<script>
    // ទទួលបាន DOM elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const loadingDiv = document.getElementById('loading');
    const loadingStatus = document.getElementById('loading-status');
    const progressBar = document.getElementById('progress-bar');
    const scannerDiv = document.getElementById('scanner');
    const scannerStatus = document.getElementById('scanner-status');
    const resultDiv = document.getElementById('result');
    const scanAgainBtn = document.getElementById('scan-again');
    const errorMessageDiv = document.getElementById('error-message');

    // កំណត់ค่า Google Sheet
    const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
    const SHEET_NAME = 'DIList';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

    const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
    let labeledFaceDescriptors = null;
    let faceMatcher = null;
    let recognitionInterval = null;
    
    // ចាប់ផ្ដើមដំណើរការកម្មវិធី
    async function setup() {
        try {
            await loadModels();
            labeledFaceDescriptors = await getLabeledFaceDescriptors();
            if (labeledFaceDescriptors.length === 0) {
                showError('មិនអាចទាញយករូបថតនិស្សិតបានទេ។ សូមពិនិត្យមើល Column រូបថតក្នុង Google Sheet។');
                return;
            }
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55); // បង្កើនកម្រិតភាពត្រឹមត្រូវ
            startCamera();
        } catch(err) {
            console.error(err);
            showError('មានបញ្ហាក្នុងការរៀបចំកម្មវិធី។ សូមព្យាយាមម្តងទៀត។');
        }
    }
    
    // បង្ហាញ Error
    function showError(message) {
        loadingDiv.classList.add('hidden');
        scannerDiv.classList.add('hidden');
        resultDiv.classList.add('hidden');
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('hidden');
    }

    // Load AI Models
    async function loadModels() {
        loadingStatus.textContent = 'កំពុងទាញយកម៉ូដែល AI (ប្រហែល 5MB)...';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
        ]);
        progressBar.style.width = '25%';
    }

    // បំលែង Google Drive URL ទៅជា Direct Link
    function transformGoogleDriveUrl(url) {
        if (!url || !url.includes('drive.google.com')) return url;
        const fileId = url.split('/d/')[1].split('/')[0];
        return `https://drive.google.com/uc?export=view&id=${fileId}`;
    }

    // ទាញយក និងរៀបចំទិន្នន័យនិស្សិត
    async function getLabeledFaceDescriptors() {
        loadingStatus.textContent = 'កំពុងទាញយកទិន្នន័យនិស្សិត...';
        progressBar.style.width = '50%';
        
        const response = await fetch(SHEET_URL);
        const csvText = await response.text();
        const rows = csvText.split('\n').slice(8); // ចាប់ផ្តើមពីជួរទី 9

        const studentData = rows.map(row => {
            const columns = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(col => col.replace(/"/g, ''));
            return {
                generation: columns[2],  // C
                academicYear: columns[3], // D
                fullName: columns[4],   // E
                group: columns[6],      // G
                id: columns[11],        // L
                latinName: columns[12], // M
                gender: columns[13],    // N
                class: columns[17],     // R
                department: columns[18], // S
                photoUrl: columns[26]  // AA
            };
        }).filter(s => s.photoUrl && s.fullName && s.id); // តម្រងយកតែ Record ដែលមានទិន្នន័យគ្រប់គ្រាន់

        loadingStatus.textContent = `រកឃើញ ${studentData.length} នាក់។ កំពុងដំណើរការរូបថត...`;
        progressBar.style.width = '75%';

        const descriptors = [];
        let loadedCount = 0;
        
        for (const student of studentData) {
            try {
                const imageUrl = transformGoogleDriveUrl(student.photoUrl);
                const img = await faceapi.fetchImage(imageUrl);
                const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                
                if (detections) {
                    const studentInfo = JSON.stringify(student); // រក្សាទុកទិន្នន័យទាំងអស់ជា String
                    descriptors.push(new faceapi.LabeledFaceDescriptor(studentInfo, [detections.descriptor]));
                }
            } catch (error) {
                console.warn(`Could not process image for ${student.fullName}: ${error}`);
            }
            loadedCount++;
            let progress = 75 + (loadedCount / studentData.length) * 25;
            progressBar.style.width = `${progress}%`;
        }
        return descriptors;
    }

    // ចាប់ផ្តើម Camera
    function startCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'user',
                    width: { ideal: 720 },
                    height: { ideal: 720 }
                } 
            })
            .then(stream => {
                video.srcObject = stream;
                loadingDiv.classList.add('hidden');
                scannerDiv.classList.remove('hidden');
            }).catch(err => {
                console.error("Camera access error:", err);
                showError('មិនអាចបើកកាមេរ៉ាបានទេ។ សូមអនុញ្ញាតឲ្យប្រើកាមេរ៉ា រួចព្យាយាមម្តងទៀត។');
            });
        } else {
            showError('កម្មវិធីរុករករបស់អ្នកមិនគាំទ្រការប្រើកាមេរ៉ាទេ។');
        }
    }

    // គ្រប់គ្រងការស្កេន
    video.addEventListener('play', () => {
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(canvas, displaySize);

        recognitionInterval = setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            
            const context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);

            if (detections.length > 0) {
                const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                
                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    if (result.label !== 'unknown') {
                        // Match Found
                        clearInterval(recognitionInterval);
                        const student = JSON.parse(result.label);
                        displayResult(student);
                        
                        // Stop camera
                        video.srcObject.getTracks().forEach(track => track.stop());
                    } else {
                        // Unknown person
                        const drawBox = new faceapi.draw.DrawBox(box, { label: 'មិនស្គាល់', boxColor: 'red' });
                        drawBox.draw(canvas);
                        scannerStatus.textContent = 'រកមិនឃើញ... សូមព្យាយាមម្តងទៀត';
                        scannerStatus.classList.replace('text-yellow-400', 'text-red-400');
                    }
                });
            } else {
                scannerStatus.textContent = 'សូមដាក់មុខចំកាមេរ៉ា';
                scannerStatus.classList.replace('text-red-400', 'text-yellow-400');
            }
        }, 300); // ស្កេនរៀងរាល់ 300ms
    });

    // បង្ហាញលទ្ធផល
    function displayResult(student) {
        scannerDiv.classList.add('hidden');
        resultDiv.classList.remove('hidden');

        document.getElementById('student-photo').src = transformGoogleDriveUrl(student.photoUrl);
        document.getElementById('student-name').textContent = student.fullName || 'N/A';
        document.getElementById('student-latin-name').textContent = student.latinName || 'N/A';
        document.getElementById('student-id').textContent = student.id || 'N/A';
        document.getElementById('student-gender').textContent = student.gender || 'N/A';
        document.getElementById('student-department').textContent = student.department || 'N/A';
        document.getElementById('student-group').textContent = student.group || 'N/A';
        document.getElementById('student-class').textContent = student.class || 'N/A';
        document.getElementById('student-generation').textContent = student.generation || 'N/A';
        document.getElementById('student-year').textContent = student.academicYear || 'N/A';
    }

    // ស្កេនម្ដងទៀត
    scanAgainBtn.addEventListener('click', () => {
        resultDiv.classList.add('hidden');
        scannerStatus.textContent = 'សូមដាក់មុខចំកាមេរ៉ា';
        scannerStatus.classList.replace('text-red-400', 'text-yellow-400');
        startCamera();
    });

    // ចាប់ផ្ដើមកម្មវិធីនៅពេលទំព័របានផ្ទុក
    window.addEventListener('load', setup);

</script>
</body>
</html>

