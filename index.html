<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធសម្គាល់អត្តសញ្ញាណនិស្សិត</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Koulen&family=Noto+Sans+Khmer:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Khmer', sans-serif;
            touch-action: manipulation;
        }
        .koulen {
            font-family: 'Koulen', cursive;
        }
        #video, #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 1.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .loader-ring {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .loader-ring div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 64px;
            height: 64px;
            margin: 8px;
            border: 8px solid #fff;
            border-radius: 50%;
            animation: loader-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            border-color: #fff transparent transparent transparent;
        }
        .loader-ring div:nth-child(1) { animation-delay: -0.45s; }
        .loader-ring div:nth-child(2) { animation-delay: -0.3s; }
        .loader-ring div:nth-child(3) { animation-delay: -0.15s; }
        @keyframes loader-ring {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-gradient {
            background: linear-gradient(145deg, #1e3a8a, #3b82f6);
        }
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col items-center justify-center p-4">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="loader-ring"><div></div><div></div><div></div><div></div></div>
        <p id="loading-text" class="mt-6 text-lg font-medium text-gray-300">កំពុងរៀបចំប្រព័ន្ធ...</p>
        <div class="w-full max-w-xs bg-gray-700 rounded-full h-2.5 mt-4">
            <div id="progress-bar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progress-label" class="text-sm mt-2 text-gray-400">0%</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="w-full max-w-md mx-auto text-center hidden">
        
        <!-- Header -->
        <header class="mb-4">
            <h1 class="text-3xl koulen text-blue-400">ប្រព័ន្ធស្វែងរកនិស្សិត</h1>
            <p class="text-gray-400">ស្កេនមុខដើម្បីបង្ហាញព័ត៌មានលម្អិត</p>
        </header>

        <!-- Scanner View -->
        <div id="scanner-view">
            <div id="video-container" class="relative w-full aspect-square bg-gray-800 rounded-3xl overflow-hidden shadow-2xl border-4 border-gray-700">
                <video id="video" playsinline muted autoplay></video>
                <canvas id="overlay"></canvas>
            </div>
            <button id="start-button" class="mt-6 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl text-lg koulen transition-transform transform hover:scale-105 shadow-lg">
                ចាប់ផ្តើមស្កេន
            </button>
        </div>

        <!-- Result View -->
        <div id="result-view" class="hidden w-full">
            <div class="card-gradient p-6 rounded-3xl shadow-2xl">
                <img id="student-photo" src="https://placehold.co/150x150/e2e8f0/e2e8f0" class="w-32 h-32 rounded-full mx-auto mb-4 border-4 border-white object-cover shadow-lg">
                <h2 id="student-name-latin" class="text-2xl font-bold text-white tracking-wide">STUDENT NAME</h2>
                <h3 id="student-name-khmer" class="text-xl font-medium text-blue-200 mb-2">ឈ្មោះភាសាខ្មែរ</h3>
                <p id="student-id" class="text-sm text-gray-300 bg-black bg-opacity-20 rounded-full px-3 py-1 inline-block">ID: N/A</p>

                <div class="mt-6 text-left grid grid-cols-2 gap-x-4 gap-y-3">
                    <div class="info-card p-3 rounded-lg col-span-2">
                        <span class="text-xs text-blue-200 block">ផ្នែកការងារ</span>
                        <p id="student-major" class="font-semibold">N/A</p>
                    </div>
                     <div class="info-card p-3 rounded-lg">
                        <span class="text-xs text-blue-200 block">ភេទ</span>
                        <p id="student-gender" class="font-semibold">N/A</p>
                    </div>
                     <div class="info-card p-3 rounded-lg">
                        <span class="text-xs text-blue-200 block">ក្រុម</span>
                        <p id="student-group" class="font-semibold">N/A</p>
                    </div>
                    <div class="info-card p-3 rounded-lg">
                        <span class="text-xs text-blue-200 block">ថ្នាក់</span>
                        <p id="student-class" class="font-semibold">N/A</p>
                    </div>
                    <div class="info-card p-3 rounded-lg">
                        <span class="text-xs text-blue-200 block">ជំនាន់</span>
                        <p id="student-generation" class="font-semibold">N/A</p>
                    </div>
                    <div class="info-card p-3 rounded-lg col-span-2">
                        <span class="text-xs text-blue-200 block">ឆ្នាំសិក្សា</span>
                        <p id="student-year" class="font-semibold">N/A</p>
                    </div>
                </div>
            </div>
            <button id="rescan-button" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-xl text-lg koulen transition-transform transform hover:scale-105 shadow-lg">
                ស្កេនម្តងទៀត
            </button>
        </div>

    </div>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const overlay = document.getElementById('overlay');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const progressBar = document.getElementById('progress-bar');
        const progressLabel = document.getElementById('progress-label');
        const mainContent = document.getElementById('main-content');
        const startButton = document.getElementById('start-button');
        const rescanButton = document.getElementById('rescan-button');
        const scannerView = document.getElementById('scanner-view');
        const resultView = document.getElementById('result-view');
        
        // --- Configuration ---
        const SPREADSHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const SHEET_NAME = 'DIList';
        const API_KEY = 'AIzaSyC6E9ON7DsgkMZEc6obtWehyqzGWwd_EII';
        const RANGE = 'C9:AA'; // Fetch all required columns in one go

        // --- State ---
        let faceMatcher;
        let studentDataMap = new Map();
        let detectionInterval;
        let isScanning = false;
        
        // Update loading progress
        function updateProgress(value, text) {
            const percentage = Math.round(value * 100);
            progressBar.style.width = `${percentage}%`;
            progressLabel.textContent = `${percentage}%`;
            if (text) loadingText.textContent = text;
        }

        // Load face-api.js models
        async function loadModels() {
            const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
            updateProgress(0.1, 'កំពុងទាញយកម៉ូឌែល...');
            await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
            updateProgress(0.3, 'កំពុងទាញយកម៉ូឌែលសម្គាល់មុខ...');
            await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
            updateProgress(0.6, 'កំពុងទាញយកម៉ូឌែលចំណាំផ្ទៃមុខ...');
            await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        }

        // Fetch and process student data from Google Sheet
        async function setupFaceMatcher() {
            updateProgress(0.8, 'កំពុងទាញយកទិន្នន័យនិស្សិត...');
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!${RANGE}?key=${API_KEY}`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Error fetching sheet data: ${response.statusText}`);
                }
                const data = await response.json();
                const rows = data.values || [];

                updateProgress(0.9, `កំពុងរៀបចំរូបភាព ${rows.length} សន្លឹក...`);

                const labeledFaceDescriptors = [];
                let processedCount = 0;

                for (const row of rows) {
                    // Column mapping based on range C9:AA
                    const generation = row[0] || 'N/A';
                    const academicYear = row[1] || 'N/A';
                    const fullNameKhmer = row[2] || 'N/A';
                    const group = row[4] || 'N/A';
                    const studentId = row[9] || 'N/A';
                    const fullNameLatin = row[10] || 'N/A';
                    const gender = row[11] || 'N/A';
                    const studentClass = row[15] || 'N/A';
                    const major = row[16] || 'N/A';
                    const imageUrl = row[24];

                    if (studentId !== 'N/A' && imageUrl) {
                        studentDataMap.set(studentId, {
                            generation, academicYear, fullNameKhmer, group, studentId,
                            fullNameLatin, gender, studentClass, major, imageUrl
                        });

                        try {
                            const img = await faceapi.fetchImage(imageUrl);
                            const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                            if (detections) {
                                labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(studentId, [detections.descriptor]));
                            }
                        } catch (e) {
                            console.warn(`Could not process image for ${studentId}: ${imageUrl}`, e);
                        }
                    }
                    processedCount++;
                    const progress = 0.9 + (processedCount / rows.length) * 0.1;
                    updateProgress(progress, `កំពុងវិភាគរូបភាពទី ${processedCount}/${rows.length}...`);
                }
                
                if (labeledFaceDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55); // Adjusted threshold for better accuracy
                } else {
                    throw new Error("No face descriptors could be created. Check image URLs and CORS policies.");
                }

            } catch (error) {
                console.error('Error setting up face matcher:', error);
                loadingText.textContent = `Error: ${error.message}`;
                progressBar.style.backgroundColor = 'red';
            }
        }
        
        // Start camera stream
        async function startVideo() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("មិនអាចបើកកាមេរ៉ាបានទេ។ សូមអនុញ្ញាតឲ្យប្រើប្រាស់កាមេរ៉ា។");
            }
        }

        // Handle video playing event
        video.addEventListener('play', () => {
            const videoContainer = document.getElementById('video-container');
            const displaySize = { width: videoContainer.clientWidth, height: videoContainer.clientHeight };
            faceapi.matchDimensions(overlay, displaySize);

            isScanning = true;
            detectionInterval = setInterval(async () => {
                if (!isScanning) return;

                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                const context = overlay.getContext('2d');
                context.clearRect(0, 0, overlay.width, overlay.height);

                if (faceMatcher) {
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    results.forEach((result, i) => {
                        const box = resizedDetections[i].detection.box;
                        const studentId = result.toString().split(' ')[0];
                        
                        // Draw a nice box
                        context.strokeStyle = 'rgba(60, 130, 246, 0.8)';
                        context.lineWidth = 4;
                        context.strokeRect(box.x, box.y, box.width, box.height);

                        if (studentId !== 'unknown') {
                            displayStudentInfo(studentId);
                            isScanning = false; 
                            clearInterval(detectionInterval);
                            video.pause();
                        }
                    });
                }
            }, 200);
        });

        // Display student information
        function displayStudentInfo(studentId) {
            const data = studentDataMap.get(studentId);
            if (data) {
                document.getElementById('student-photo').src = data.imageUrl;
                document.getElementById('student-name-latin').textContent = data.fullNameLatin;
                document.getElementById('student-name-khmer').textContent = data.fullNameKhmer;
                document.getElementById('student-id').textContent = `ID: ${data.studentId}`;
                document.getElementById('student-major').textContent = data.major;
                document.getElementById('student-gender').textContent = data.gender;
                document.getElementById('student-group').textContent = data.group;
                document.getElementById('student-class').textContent = data.studentClass;
                document.getElementById('student-generation').textContent = data.generation;
                document.getElementById('student-year').textContent = data.academicYear;

                scannerView.classList.add('hidden');
                resultView.classList.remove('hidden');
            }
        }
        
        // Event Listeners
        startButton.addEventListener('click', () => {
             if (!video.srcObject) {
                startVideo();
            } else {
                video.play();
            }
            startButton.textContent = "សូមតម្រង់កាមេរ៉ាទៅផ្ទៃមុខ...";
            startButton.disabled = true;
        });

        rescanButton.addEventListener('click', () => {
            resultView.classList.add('hidden');
            scannerView.classList.remove('hidden');
            startButton.textContent = "ចាប់ផ្តើមស្កេន";
            startButton.disabled = false;
            video.play();
        });

        // --- Initialization ---
        async function initialize() {
            await loadModels();
            await setupFaceMatcher();
            
            // Fade out loading screen
            loadingOverlay.classList.add('opacity-0');
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
            }, 500);
        }

        initialize();

    </script>
</body>
</html>
