<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ប្រព័ន្ធស្វែងរកព័ត៌មាននិស្សិត</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        #cameraModal {
            background-color: rgba(0,0,0,0.8);
        }
        #video, #overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-md mx-auto">
        <div class="bg-gray-800 shadow-2xl rounded-2xl p-6">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-cyan-400">ស្វែងរកព័ត៌មាននិស្សិត</h1>
                <p class="text-gray-400 mt-2">បញ្ចូលអត្តលេខ ឬប្រើរូបថតដើម្បីស្វែងរក</p>
            </div>

            <!-- Search Form -->
            <div class="space-y-4">
                <div class="flex space-x-2">
                    <input type="text" id="studentIdInput" class="flex-grow bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-cyan-500 focus:border-cyan-500 block w-full p-2.5" placeholder="ឧទាហរណ៍: DI0001" required>
                    <button id="searchButton" class="text-white bg-cyan-600 hover:bg-cyan-700 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
                        <i class="fa fa-search"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                     <button id="scanFaceButton" class="w-full text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:outline-none focus:ring-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center justify-center space-x-2">
                        <i class="fa-solid fa-camera"></i>
                        <span>ស្កេនមុខ</span>
                    </button>
                    <button id="uploadImageButton" class="w-full text-white bg-purple-600 hover:bg-purple-700 focus:ring-4 focus:outline-none focus:ring-purple-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center flex items-center justify-center space-x-2">
                        <i class="fa-solid fa-upload"></i>
                        <span>Upload រូប</span>
                    </button>
                    <input type="file" id="imageUploadInput" accept="image/*" class="hidden">
                </div>
            </div>

            <!-- Status/Message Area -->
            <div id="statusMessage" class="text-center text-yellow-400 min-h-[24px] my-4"></div>

            <!-- Student Info Card (hidden by default) -->
            <div id="studentInfoCard" class="bg-gray-700 p-5 rounded-xl hidden">
                <!-- Content is populated by JS -->
            </div>
        </div>
        <footer class="text-center text-gray-500 text-xs mt-4">
            <p>DI Student Information System &copy; 2025</p>
        </footer>
    </div>
    
    <!-- Camera Modal -->
    <div id="cameraModal" class="fixed inset-0 w-full h-full z-50 hidden items-center justify-center">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <button id="closeModalButton" class="absolute top-4 right-4 text-white text-3xl z-50"><i class="fa-solid fa-xmark"></i></button>
        <button id="switchCameraButton" class="absolute bottom-4 left-4 text-white bg-gray-700/50 p-3 rounded-full z-50"><i class="fa-solid fa-camera-rotate"></i></button>
        <div id="scanStatus" class="absolute bottom-4 text-white bg-black/50 px-4 py-2 rounded-lg">កំពុងស្វែងរកមុខ...</div>
    </div>

<script>
    // --- Configuration ---
    const API_KEY = 'AIzaSyC6E9ON7DsgkMZEc6obtWehyqzGWwd_EII';
    const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
    const SHEET_NAME = 'DIList';
    const DATA_RANGE = 'C9:AA';
    const FACEAPI_MODELS_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';

    // --- DOM Elements ---
    const searchButton = document.getElementById('searchButton');
    const scanFaceButton = document.getElementById('scanFaceButton');
    const uploadImageButton = document.getElementById('uploadImageButton');
    const imageUploadInput = document.getElementById('imageUploadInput');
    const studentIdInput = document.getElementById('studentIdInput');
    const statusMessage = document.getElementById('statusMessage');
    const studentInfoCard = document.getElementById('studentInfoCard');
    const cameraModal = document.getElementById('cameraModal');
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const closeModalButton = document.getElementById('closeModalButton');
    const switchCameraButton = document.getElementById('switchCameraButton');
    const scanStatus = document.getElementById('scanStatus');
    
    // --- State Variables ---
    let studentDataCache = [];
    let faceMatcher = null;
    let currentStream;
    let scanInterval;
    let facingMode = 'environment'; // 'user' for front, 'environment' for back camera

    // Column indices based on the range C9:AA
    const COL_INDEX = {
        GENERATION: 0, YEAR: 1, ID: 2, /* E */ GROUP: 4, NAME_KHMER: 9, /* L */
        NAME_LATIN: 10, GENDER: 11, CLASS: 15, DEPARTMENT: 16, IMAGE_URL: 24
    };

    /**
     * Main initialization function on window load
     */
    window.addEventListener('load', async () => {
        statusMessage.textContent = 'កំពុងដំណើរការ Face API models...';
        await Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri(FACEAPI_MODELS_URL),
            faceapi.nets.faceLandmark68Net.loadFromUri(FACEAPI_MODELS_URL),
            faceapi.nets.faceRecognitionNet.loadFromUri(FACEAPI_MODELS_URL),
            faceapi.nets.ssdMobilenetv1.loadFromUri(FACEAPI_MODELS_URL),
        ]);
        await fetchAndPrepareData();
    });

    /**
     * Fetches data from Google Sheets and prepares face matcher.
     */
    async function fetchAndPrepareData() {
        statusMessage.textContent = 'កំពុងទាញយកទិន្នន័យនិស្សិត...';
        try {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_NAME}!${DATA_RANGE}?key=${API_KEY}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error ${response.status}`);
            const data = await response.json();
            
            if (!data.values || data.values.length === 0) {
                statusMessage.textContent = 'មិនមានទិន្នន័យក្នុង Google Sheet ទេ។';
                return;
            }
            studentDataCache = data.values;
            statusMessage.textContent = 'ទាញយកទិន្នន័យជោគជ័យ!';
            
            await createFaceMatcher();
        } catch (error) {
            console.error('Failed to fetch data:', error);
            statusMessage.textContent = 'មានបញ្ហាក្នុងការតភ្ជាប់ទៅ Google Sheet។';
        }
    }

    /**
     * Creates a face matcher from the cached student data.
     */
    async function createFaceMatcher() {
        if (studentDataCache.length === 0) return;
        statusMessage.textContent = 'កំពុងរៀបចំទិន្នន័យរូបភាព... (0%)';
        const labeledFaceDescriptors = [];
        let processedCount = 0;

        const studentsWithImages = studentDataCache.filter(row => row[COL_INDEX.IMAGE_URL]);

        for (const row of studentsWithImages) {
            const label = row[COL_INDEX.ID];
            const imageUrl = row[COL_INDEX.IMAGE_URL];
            if (label && imageUrl) {
                try {
                    const img = await faceapi.fetchImage(imageUrl);
                    const detections = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    if (detections) {
                        labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(label, [detections.descriptor]));
                    }
                } catch (e) {
                    console.error(`Could not process image for ${label}: ${imageUrl}`, e);
                }
            }
            processedCount++;
            const percent = Math.round((processedCount / studentsWithImages.length) * 100);
            statusMessage.textContent = `កំពុងរៀបចំទិន្នន័យរូបភាព... (${percent}%)`;
        }

        if (labeledFaceDescriptors.length > 0) {
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55); // Adjust threshold if needed
            statusMessage.textContent = 'ប្រព័ន្ធបានត្រៀមរួចរាល់! សូមស្វែងរក។';
        } else {
            statusMessage.textContent = 'មិនអាចបង្កើតទិន្នន័យផ្ទៃមុខបានទេ, សូមពិនិត្យ URL រូបភាព។';
        }
    }
    
    /**
     * Displays the found student's information on the card.
     */
    function displayStudentInfo(row) {
        const getCellData = (index) => row[index] || 'មិនមានទិន្នន័យ';
        studentInfoCard.innerHTML = `
            <div class="flex flex-col items-center text-center">
                <div class="w-32 h-32 rounded-full mb-4 overflow-hidden border-4 border-cyan-500 shadow-lg">
                    <img src="${getCellData(COL_INDEX.IMAGE_URL)}" alt="រូបថតនិស្សិត" class="w-full h-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/128x128/4A5568/A0AEC0?text=No+Image';">
                </div>
                <h2 class="text-2xl font-bold text-white">${getCellData(COL_INDEX.NAME_LATIN)}</h2>
                <p class="text-lg text-cyan-300">${getCellData(COL_INDEX.NAME_KHMER)}</p>
                <p class="text-sm text-gray-400 mt-1">អត្តលេខ: ${getCellData(COL_INDEX.ID)}</p>
            </div>
            <div class="border-t border-gray-600 my-4"></div>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span class="font-semibold text-gray-400">ជំនាន់:</span><span class="font-medium text-right">${getCellData(COL_INDEX.GENERATION)}</span></div>
                <div class="flex justify-between"><span class="font-semibold text-gray-400">ឆ្នាំសិក្សា:</span><span class="font-medium text-right">${getCellData(COL_INDEX.YEAR)}</span></div>
                <div class="flex justify-between"><span class="font-semibold text-gray-400">ក្រុម:</span><span class="font-medium text-right">${getCellData(COL_INDEX.GROUP)}</span></div>
                <div class="flex justify-between"><span class="font-semibold text-gray-400">ថ្នាក់:</span><span class="font-medium text-right">${getCellData(COL_INDEX.CLASS)}</span></div>
                <div class="flex justify-between"><span class="font-semibold text-gray-400">ផ្នែកការងារ:</span><span class="font-medium text-right">${getCellData(COL_INDEX.DEPARTMENT)}</span></div>
                <div class="flex justify-between"><span class="font-semibold text-gray-400">ភេទ:</span><span class="font-medium text-right">${getCellData(COL_INDEX.GENDER)}</span></div>
            </div>`;
        studentInfoCard.classList.remove('hidden');
    }

    function findStudentById(idToSearch) {
        if (!idToSearch) {
            statusMessage.textContent = 'សូមបញ្ចូលអត្តលេខនិស្សិត។';
            return;
        }
        const targetId = idToSearch.trim().toUpperCase();
        const studentRow = studentDataCache.find(row => row[COL_INDEX.ID] && row[COL_INDEX.ID].toUpperCase() === targetId);

        if (studentRow) {
            displayStudentInfo(studentRow);
            statusMessage.textContent = '';
        } else {
            statusMessage.textContent = `រកមិនឃើញនិស្សិតមានអត្តលេខ "${idToSearch}" ទេ។`;
            studentInfoCard.classList.add('hidden');
        }
    }
    
    async function startCamera(mode) {
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: mode }
            });
            video.srcObject = currentStream;
            cameraModal.classList.remove('hidden');
            cameraModal.classList.add('flex');
        } catch (err) {
            console.error("Camera Error:", err);
            statusMessage.textContent = "មិនអាចចូលប្រើកាមេរ៉ាបានទេ។";
        }
    }

    video.addEventListener('play', () => {
        const displaySize = { width: video.clientWidth, height: video.clientHeight };
        faceapi.matchDimensions(overlay, displaySize);

        scanInterval = setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptors();
            const resizedDetections = faceapi.resizeResults(detections, displaySize);
            
            overlay.getContext('2d').clearRect(0, 0, overlay.width, overlay.height);
            faceapi.draw.drawDetections(overlay, resizedDetections);
            
            if (detections.length > 0 && faceMatcher) {
                scanStatus.textContent = "រកឃើញមុខ! កំពុងផ្ទៀងផ្ទាត់...";
                const bestMatch = detections.map(d => faceMatcher.findBestMatch(d.descriptor))
                                            .sort((a,b) => a.distance - b.distance)[0];
                
                if (bestMatch && bestMatch.label !== 'unknown') {
                    const studentRow = studentDataCache.find(row => row[COL_INDEX.ID] === bestMatch.label);
                    if (studentRow) {
                        displayStudentInfo(studentRow);
                        stopCamera();
                    }
                } else {
                    scanStatus.textContent = "មិនស្គាល់មុខ, សូមព្យាយាមម្តងទៀត";
                }
            } else {
                 scanStatus.textContent = "កំពុងស្វែងរកមុខ...";
            }
        }, 300);
    });
    
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        clearInterval(scanInterval);
        cameraModal.classList.add('hidden');
        cameraModal.classList.remove('flex');
    }
    
    async function handleImageUpload(event) {
        if (!faceMatcher) {
            statusMessage.textContent = 'ប្រព័ន្ធមិនទាន់រួចរាល់ទេ, សូមរង់ចាំ...';
            return;
        }
        const file = event.target.files[0];
        if (!file) return;

        statusMessage.textContent = 'កំពុងវិភាគរូបភាព...';
        studentInfoCard.classList.add('hidden');

        const image = await faceapi.bufferToImage(file);
        const detections = await faceapi.detectSingleFace(image, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();

        if (detections) {
            const bestMatch = faceMatcher.findBestMatch(detections.descriptor);
            if (bestMatch && bestMatch.label !== 'unknown') {
                const studentRow = studentDataCache.find(row => row[COL_INDEX.ID] === bestMatch.label);
                displayStudentInfo(studentRow);
                statusMessage.textContent = 'រកឃើញព័ត៌មាន!';
            } else {
                statusMessage.textContent = 'រកមិនឃើញទិន្នន័យដែលត្រូវគ្នាទេ។';
            }
        } else {
            statusMessage.textContent = 'រកមិនឃើញមុខនៅក្នុងរូបភាពទេ។';
        }
    }
    
    // --- Event Listeners ---
    searchButton.addEventListener('click', () => findStudentById(studentIdInput.value));
    studentIdInput.addEventListener('keyup', (e) => e.key === 'Enter' && findStudentById(studentIdInput.value));
    scanFaceButton.addEventListener('click', () => startCamera(facingMode));
    closeModalButton.addEventListener('click', stopCamera);
    switchCameraButton.addEventListener('click', () => {
        facingMode = facingMode === 'user' ? 'environment' : 'user';
        stopCamera();
        setTimeout(() => startCamera(facingMode), 100);
    });
    uploadImageButton.addEventListener('click', () => imageUploadInput.click());
    imageUploadInput.addEventListener('change', handleImageUpload);

</script>
</body>
</html>





